const { PrismaClient } = require('@prisma/client')
const prisma = new PrismaClient()

/**
 * Seed Payroll Accounts Demo Data
 * Creates payroll accounts, deposits, and payments for demo businesses
 */

function randomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min
}

function getDaysAgo(days) {
  const date = new Date()
  date.setDate(date.getDate() - days)
  return date
}

async function seedPayrollAccountsDemo() {
  console.log('ğŸ’° Starting Payroll Accounts Demo Data Seeding...\n')

  try {
    // Get demo businesses
    const demoBusinesses = await prisma.businesses.findMany({
      where: { isDemo: true },
      select: { id: true, name: true, type: true }
    })

    console.log(`Found ${demoBusinesses.length} demo businesses\n`)

    if (demoBusinesses.length === 0) {
      console.log('âŒ No demo businesses found. Please run business seed scripts first.')
      return
    }

    // Get admin user for transactions
    const adminUser = await prisma.users.findFirst({
      where: { email: { contains: 'admin' } },
      select: { id: true }
    })

    if (!adminUser) {
      console.log('âŒ No admin user found. Cannot create payroll accounts.')
      return
    }

    let totalAccounts = 0
    let totalDeposits = 0
    let totalPayments = 0

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CREATE PAYROLL ACCOUNTS FOR EACH DEMO BUSINESS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    for (const business of demoBusinesses) {
      console.log(`ğŸ’¼ Setting up payroll account for: ${business.name}`)

      // Check if payroll account already exists
      let payrollAccount = await prisma.payrollAccounts.findFirst({
        where: { businessId: business.id }
      })

      if (!payrollAccount) {
        // Generate account number
        const accountNumber = `PAY-${business.type.substring(0, 3).toUpperCase()}-${String(totalAccounts + 1).padStart(3, '0')}`

        // Create payroll account with starting balance
        const startingBalance = randomInt(50000, 150000)

        payrollAccount = await prisma.payrollAccounts.create({
          data: {
            businessId: business.id,
            accountNumber: accountNumber,
            balance: startingBalance,
            isActive: true,
            createdBy: adminUser.id,
            createdAt: getDaysAgo(90) // Created 90 days ago
          }
        })

        console.log(`  âœ… Created payroll account: ${accountNumber}`)
        console.log(`     Starting balance: $${startingBalance.toLocaleString()}`)
        totalAccounts++
      } else {
        console.log(`  âœ… Using existing payroll account: ${payrollAccount.accountNumber}`)
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // CREATE DEPOSITS (Funding the payroll account)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      console.log(`\n  ğŸ’µ Creating payroll deposits...`)

      const depositCount = randomInt(2, 3)
      for (let i = 0; i < depositCount; i++) {
        const daysAgo = randomInt(10, 60)
        const depositAmount = randomInt(30000, 80000)

        await prisma.payrollAccountDeposits.create({
          data: {
            payrollAccountId: payrollAccount.id,
            businessId: business.id,
            amount: depositAmount,
            depositDate: getDaysAgo(daysAgo),
            transactionType: i === 0 ? 'initial_funding' : 'monthly_transfer',
            autoGeneratedNote: i === 0
              ? 'Initial payroll account funding'
              : `Monthly payroll funding for ${new Date(getDaysAgo(daysAgo)).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`,
            createdBy: adminUser.id,
            createdAt: getDaysAgo(daysAgo)
          }
        })

        totalDeposits++
      }

      console.log(`     âœ… Created ${depositCount} deposits`)

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // CREATE PAYMENTS (Payroll disbursements to employees)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      console.log(`\n  ğŸ’¸ Creating payroll payments...`)

      // Get employees for this business
      const employees = await prisma.employees.findMany({
        where: { primaryBusinessId: business.id },
        select: { id: true, fullName: true }
      })

      if (employees.length > 0) {
        const paymentCount = randomInt(1, 2)

        for (let i = 0; i < paymentCount; i++) {
          const daysAgo = randomInt(5, 45)
          const employee = employees[i % employees.length]
          const paymentAmount = randomInt(2500, 8000)

          await prisma.payrollAccountPayments.create({
            data: {
              payrollAccountId: payrollAccount.id,
              employeeId: employee.id,
              amount: paymentAmount,
              paymentDate: getDaysAgo(daysAgo),
              paymentType: 'regular_salary',
              status: daysAgo > 30 ? 'COMPLETED' : (daysAgo > 7 ? 'COMPLETED' : 'PENDING'),
              isAdvance: false,
              isLocked: daysAgo > 30,
              createdBy: adminUser.id,
              createdAt: getDaysAgo(daysAgo)
            }
          })

          totalPayments++
        }

        console.log(`     âœ… Created ${paymentCount} payments`)
      } else {
        console.log(`     âš ï¸  No employees found - skipping payments`)
      }

      // Update account balance based on deposits and payments
      const deposits = await prisma.payrollAccountDeposits.aggregate({
        where: { payrollAccountId: payrollAccount.id },
        _sum: { amount: true }
      })

      const payments = await prisma.payrollAccountPayments.aggregate({
        where: { payrollAccountId: payrollAccount.id },
        _sum: { amount: true }
      })

      const totalDepositsAmount = deposits._sum.amount || 0
      const totalPaymentsAmount = payments._sum.amount || 0
      const currentBalance = Number(totalDepositsAmount) - Number(totalPaymentsAmount)

      await prisma.payrollAccounts.update({
        where: { id: payrollAccount.id },
        data: { balance: currentBalance }
      })

      console.log(`\n  ğŸ“Š Account Summary:`)
      console.log(`     Total Deposits: $${Number(totalDepositsAmount).toLocaleString()}`)
      console.log(`     Total Payments: $${Number(totalPaymentsAmount).toLocaleString()}`)
      console.log(`     Current Balance: $${currentBalance.toLocaleString()}`)
      console.log('')
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SUMMARY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—')
    console.log('â•‘    âœ… Payroll Accounts Demo Seeding Complete!             â•‘')
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')

    console.log('\nğŸ“Š Summary:')
    console.log(`   Payroll Accounts Created: ${totalAccounts}`)
    console.log(`   Total Deposits: ${totalDeposits}`)
    console.log(`   Total Payments: ${totalPayments}`)

    // Get final totals
    const allAccounts = await prisma.payrollAccounts.findMany({
      where: { businesses: { isDemo: true } },
      select: { accountNumber: true, balance: true, businesses: { select: { name: true } } }
    })

    console.log('\nğŸ’° Payroll Account Balances:')
    for (const account of allAccounts) {
      console.log(`   ${account.businesses?.name}: $${Number(account.balance).toLocaleString()} (${account.accountNumber})`)
    }

    console.log('\nğŸ§ª Testing:')
    console.log('   - View payroll account dashboard')
    console.log('   - Create new deposits')
    console.log('   - Process payroll payments')
    console.log('   - View transaction history')

  } catch (error) {
    console.error('âŒ Error seeding payroll accounts demo data:', error)
    throw error
  } finally {
    await prisma.$disconnect()
  }
}

// Run the seeding function
seedPayrollAccountsDemo()
  .then(() => {
    console.log('\nâœ¨ Seeding script completed successfully!')
    process.exit(0)
  })
  .catch((error) => {
    console.error('\nğŸ’¥ Seeding script failed:', error)
    process.exit(1)
  })
