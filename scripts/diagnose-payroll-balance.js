const { PrismaClient } = require('@prisma/client')

const prisma = new PrismaClient()

async function diagnoseBalance() {
  console.log('üîç DIAGNOSING PAYROLL BALANCE ISSUE\n')
  console.log('=' .repeat(60))

  try {
    // 1. Get the payroll account
    console.log('\nüìã Step 1: Fetch Payroll Account')
    console.log('-'.repeat(60))

    const payrollAccount = await prisma.payrollAccounts.findFirst({
      where: { businessId: null }
    })

    if (!payrollAccount) {
      console.log('‚ùå No payroll account found!')
      return
    }

    console.log(`‚úÖ Payroll Account Found:`)
    console.log(`   ID: ${payrollAccount.id}`)
    console.log(`   Account Number: ${payrollAccount.accountNumber}`)
    console.log(`   Stored Balance: $${Number(payrollAccount.balance).toFixed(2)}`)

    // 2. Get all deposits
    console.log('\nüìã Step 2: Fetch All Deposits')
    console.log('-'.repeat(60))

    const deposits = await prisma.payrollAccountDeposits.findMany({
      where: { payrollAccountId: payrollAccount.id },
      include: {
        businesses: {
          select: { name: true }
        }
      },
      orderBy: { depositDate: 'asc' }
    })

    console.log(`Found ${deposits.length} deposit(s):\n`)

    let totalDepositsCalculated = 0
    deposits.forEach((d, index) => {
      const amount = Number(d.amount)
      totalDepositsCalculated += amount
      console.log(`   ${index + 1}. $${amount.toFixed(2)} from ${d.businesses?.name || 'Unknown'}`)
      console.log(`      Date: ${d.depositDate}`)
      console.log(`      Type: ${d.transactionType}`)
      console.log(`      Note: ${d.autoGeneratedNote}`)
      console.log(`      Raw amount value: ${d.amount}`)
      console.log(`      Raw amount type: ${typeof d.amount}`)
      console.log('')
    })

    console.log(`   üìä Total Deposits (calculated): $${totalDepositsCalculated.toFixed(2)}`)

    // 3. Get all payments
    console.log('\nüìã Step 3: Fetch All Payments')
    console.log('-'.repeat(60))

    const payments = await prisma.payrollPayments.findMany({
      where: { payrollAccountId: payrollAccount.id },
      orderBy: { paymentDate: 'desc' }
    })

    console.log(`Found ${payments.length} payment(s):\n`)

    let totalPaymentsCalculated = 0
    payments.forEach((p, index) => {
      const amount = Number(p.amount)
      totalPaymentsCalculated += amount
      console.log(`   ${index + 1}. $${amount.toFixed(2)}`)
      console.log(`      Status: ${p.status}`)
      console.log(`      Date: ${p.paymentDate}`)
      console.log('')
    })

    console.log(`   üìä Total Payments (calculated): $${totalPaymentsCalculated.toFixed(2)}`)

    // 4. Calculate expected balance
    console.log('\nüìã Step 4: Calculate Expected Balance')
    console.log('-'.repeat(60))

    const expectedBalance = totalDepositsCalculated - totalPaymentsCalculated
    const storedBalance = Number(payrollAccount.balance)

    console.log(`   Total Deposits: $${totalDepositsCalculated.toFixed(2)}`)
    console.log(`   Total Payments: $${totalPaymentsCalculated.toFixed(2)}`)
    console.log(`   Expected Balance: $${expectedBalance.toFixed(2)}`)
    console.log(`   Stored Balance: $${storedBalance.toFixed(2)}`)
    console.log(`   Difference: $${(expectedBalance - storedBalance).toFixed(2)}`)

    // 5. Check the balance calculation logic
    console.log('\nüìã Step 5: Test Balance Calculation Query')
    console.log('-'.repeat(60))

    const result = await prisma.payrollAccountDeposits.aggregate({
      where: { payrollAccountId: payrollAccount.id },
      _sum: { amount: true }
    })

    const aggregateSum = Number(result._sum.amount || 0)
    console.log(`   Prisma aggregate sum: $${aggregateSum.toFixed(2)}`)
    console.log(`   Manual calculation: $${totalDepositsCalculated.toFixed(2)}`)
    console.log(`   Match: ${aggregateSum === totalDepositsCalculated ? '‚úÖ YES' : '‚ùå NO'}`)

    // 6. Summary
    console.log('\n' + '='.repeat(60))
    console.log('üìä DIAGNOSIS SUMMARY')
    console.log('='.repeat(60))

    if (Math.abs(expectedBalance - storedBalance) < 0.01) {
      console.log('‚úÖ Balance is CORRECT')
    } else {
      console.log('‚ùå Balance MISMATCH detected!')
      console.log(`   Expected: $${expectedBalance.toFixed(2)}`)
      console.log(`   Stored: $${storedBalance.toFixed(2)}`)
      console.log(`   Difference: $${(expectedBalance - storedBalance).toFixed(2)}`)

      console.log('\nüîß Possible Issues:')
      console.log('   1. Balance update function is not calculating correctly')
      console.log('   2. Decimal conversion issue (Prisma Decimal ‚Üí Number)')
      console.log('   3. Balance not updated after deposit')
      console.log('   4. Multiple deposits with incorrect aggregation')
    }

  } catch (error) {
    console.error('‚ùå ERROR:', error.message)
    console.error(error)
  } finally {
    await prisma.$disconnect()
  }
}

diagnoseBalance()
