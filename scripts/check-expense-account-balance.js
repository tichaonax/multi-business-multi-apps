/**
 * Check Expense Account Balance
 * Verifies deposits, payments, and calculated balance
 */

const { PrismaClient } = require('@prisma/client')
const prisma = new PrismaClient()

async function checkExpenseAccountBalance() {
  const accountId = '45a2cb61-1dee-45a5-b2d4-4681df533e1e'

  console.log('\nüìä Checking Expense Account Balance...\n')

  // Get account details
  const account = await prisma.expenseAccounts.findUnique({
    where: { id: accountId },
    select: {
      id: true,
      accountNumber: true,
      accountName: true,
      balance: true,
      isActive: true,
    },
  })

  if (!account) {
    console.log('‚ùå Account not found')
    return
  }

  console.log('üìã Account Details:')
  console.log(`   Name: ${account.accountName}`)
  console.log(`   Number: ${account.accountNumber}`)
  console.log(`   Stored Balance: $${account.balance}`)
  console.log(`   Active: ${account.isActive}\n`)

  // Get all deposits
  const deposits = await prisma.expenseAccountDeposits.findMany({
    where: { expenseAccountId: accountId },
    select: {
      id: true,
      amount: true,
      depositDate: true,
      manualNote: true,
      autoGeneratedNote: true,
    },
    orderBy: { depositDate: 'asc' },
  })

  const totalDeposits = deposits.reduce((sum, d) => sum + Number(d.amount), 0)

  console.log(`üí∞ Deposits (${deposits.length} total):`)
  if (deposits.length === 0) {
    console.log('   No deposits found')
  } else {
    deposits.forEach((d) => {
      const note = d.manualNote || d.autoGeneratedNote || 'No note'
      console.log(`   ${d.depositDate.toISOString().split('T')[0]} - $${d.amount} - ${note}`)
    })
  }
  console.log(`   TOTAL DEPOSITS: $${totalDeposits}\n`)

  // Get all payments (SUBMITTED only)
  const payments = await prisma.expenseAccountPayments.findMany({
    where: {
      expenseAccountId: accountId,
      status: 'SUBMITTED',
    },
    select: {
      id: true,
      amount: true,
      paymentDate: true,
      status: true,
      notes: true,
      payeePerson: {
        select: { fullName: true },
      },
      category: {
        select: { name: true },
      },
    },
    orderBy: { paymentDate: 'asc' },
  })

  const totalPayments = payments.reduce((sum, p) => sum + Number(p.amount), 0)

  console.log(`üí∏ Payments - SUBMITTED (${payments.length} total):`)
  if (payments.length === 0) {
    console.log('   No submitted payments found')
  } else {
    payments.forEach((p) => {
      const payee = p.payeePerson?.fullName || 'Unknown'
      const category = p.category?.name || 'No category'
      console.log(`   ${p.paymentDate.toISOString().split('T')[0]} - $${p.amount} - ${payee} - ${category}`)
    })
  }
  console.log(`   TOTAL PAYMENTS: $${totalPayments}\n`)

  // Get draft payments
  const draftPayments = await prisma.expenseAccountPayments.findMany({
    where: {
      expenseAccountId: accountId,
      status: 'DRAFT',
    },
    select: {
      id: true,
      amount: true,
    },
  })

  const totalDrafts = draftPayments.reduce((sum, p) => sum + Number(p.amount), 0)

  console.log(`üìù Draft Payments (${draftPayments.length} total):`)
  console.log(`   TOTAL DRAFTS: $${totalDrafts}\n`)

  // Calculate balance
  const calculatedBalance = totalDeposits - totalPayments

  console.log('üßÆ Balance Calculation:')
  console.log(`   Total Deposits:  $${totalDeposits}`)
  console.log(`   Total Payments:  $${totalPayments}`)
  console.log(`   -------------------------`)
  console.log(`   Calculated Balance: $${calculatedBalance}`)
  console.log(`   Stored Balance:     $${account.balance}`)
  console.log(`   Match: ${calculatedBalance === Number(account.balance) ? '‚úÖ YES' : '‚ùå NO'}\n`)

  if (calculatedBalance !== Number(account.balance)) {
    console.log('‚ö†Ô∏è  BALANCE MISMATCH DETECTED!')
    console.log(`   Difference: $${Math.abs(calculatedBalance - Number(account.balance))}`)
  }
}

async function main() {
  try {
    await checkExpenseAccountBalance()
  } catch (error) {
    console.error('‚ùå Error:', error)
  } finally {
    await prisma.$disconnect()
  }
}

main()
