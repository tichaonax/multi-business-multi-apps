/**
 * Verify Expense Account Seeding
 * Checks that expense accounts and deposits were created correctly
 */

const { PrismaClient } = require('@prisma/client')
const prisma = new PrismaClient()

async function verifyExpenseAccountSeeding() {
  try {
    console.log('\nüîç VERIFYING EXPENSE ACCOUNT SEEDING\n')
    console.log('=' .repeat(60))

    // Check expense accounts
    console.log('\n1Ô∏è‚É£  Checking expense accounts...\n')

    const accounts = await prisma.expenseAccounts.findMany({
      include: {
        _count: {
          select: {
            deposits: true,
            payments: true
          }
        }
      },
      orderBy: {
        accountNumber: 'asc'
      }
    })

    if (accounts.length === 0) {
      console.log('   ‚ùå No expense accounts found!')
      return
    }

    console.log(`   ‚úÖ Found ${accounts.length} expense accounts:\n`)

    accounts.forEach(account => {
      console.log(`   üìä ${account.accountName}`)
      console.log(`      Number: ${account.accountNumber}`)
      console.log(`      Balance: $${parseFloat(account.balance).toFixed(2)}`)
      console.log(`      Description: ${account.description}`)
      console.log(`      Active: ${account.isActive ? '‚úÖ Yes' : '‚ùå No'}`)
      console.log(`      Deposits: ${account._count.deposits}`)
      console.log(`      Payments: ${account._count.payments}`)
      console.log('')
    })

    // Check deposits
    console.log('2Ô∏è‚É£  Checking expense account deposits...\n')

    const deposits = await prisma.expenseAccountDeposits.findMany({
      include: {
        expenseAccount: {
          select: {
            accountName: true,
            accountNumber: true
          }
        },
        creator: {
          select: {
            name: true,
            email: true
          }
        }
      },
      orderBy: {
        depositDate: 'desc'
      }
    })

    if (deposits.length === 0) {
      console.log('   ‚ö†Ô∏è  No deposits found!')
    } else {
      console.log(`   ‚úÖ Found ${deposits.length} deposits:\n`)

      deposits.forEach(deposit => {
        console.log(`   üíµ ${deposit.expenseAccount.accountName} (${deposit.expenseAccount.accountNumber})`)
        console.log(`      Amount: $${parseFloat(deposit.amount).toFixed(2)}`)
        console.log(`      Source Type: ${deposit.sourceType}`)
        console.log(`      Date: ${deposit.depositDate.toISOString().split('T')[0]}`)
        console.log(`      Note: ${deposit.manualNote || deposit.autoGeneratedNote || 'N/A'}`)
        console.log(`      Created By: ${deposit.creator.name} (${deposit.creator.email})`)
        console.log('')
      })
    }

    // Check admin permissions
    console.log('3Ô∏è‚É£  Checking admin user permissions...\n')

    const adminUser = await prisma.users.findUnique({
      where: { email: 'admin@business.local' },
      select: {
        name: true,
        email: true,
        role: true,
        permissions: true
      }
    })

    if (!adminUser) {
      console.log('   ‚ùå Admin user not found!')
    } else {
      console.log(`   ‚úÖ Admin user: ${adminUser.name} (${adminUser.email})`)
      console.log(`   Role: ${adminUser.role}\n`)

      const permissions = adminUser.permissions || {}
      const expensePermissions = {
        canAccessExpenseAccount: permissions.canAccessExpenseAccount,
        canCreateExpenseAccount: permissions.canCreateExpenseAccount,
        canMakeExpenseDeposits: permissions.canMakeExpenseDeposits,
        canMakeExpensePayments: permissions.canMakeExpensePayments,
        canViewExpenseReports: permissions.canViewExpenseReports,
        canCreateIndividualPayees: permissions.canCreateIndividualPayees,
        canDeleteExpenseAccounts: permissions.canDeleteExpenseAccounts,
        canAdjustExpensePayments: permissions.canAdjustExpensePayments
      }

      console.log('   Expense Account Permissions:')
      Object.entries(expensePermissions).forEach(([key, value]) => {
        const icon = value ? '‚úÖ' : '‚ùå'
        console.log(`   ${icon} ${key}: ${value || false}`)
      })
    }

    console.log('\n' + '='.repeat(60))
    console.log('‚úÖ Verification complete\n')

  } catch (error) {
    console.error('‚ùå Error verifying expense account seeding:', error)
  } finally {
    await prisma.$disconnect()
  }
}

verifyExpenseAccountSeeding()
