# Payroll Account System API Documentation

## Overview

The Payroll Account System provides a dedicated account for managing employee salary payments with deposit tracking, batch payment processing, payment vouchers, and permission-based access control.

**Version:** 1.0.0
**Last Updated:** 2025-11-24

---

## Table of Contents

1. [Authentication & Permissions](#authentication--permissions)
2. [API Endpoints](#api-endpoints)
3. [Data Models](#data-models)
4. [Error Handling](#error-handling)
5. [Usage Examples](#usage-examples)
6. [Security Considerations](#security-considerations)

---

## Authentication & Permissions

All API endpoints require authentication via NextAuth session cookies.

### Required Permissions

| Permission | Description | Required For |
|------------|-------------|--------------|
| `canAccessPayrollAccount` | View payroll account dashboard | All payroll account pages |
| `canViewPayrollAccountBalance` | View account balance and summary | Balance endpoints |
| `canMakePayrollDeposits` | Create deposits from business accounts | POST /deposits |
| `canMakePayrollPayments` | Create and process payments | POST /payments |
| `canAdjustPaymentAmounts` | Modify payment amounts before signing | PATCH /payments/:id |
| `canIssuePaymentVouchers` | Generate payment vouchers | POST /vouchers |
| `canCompletePayments` | Mark payments as completed | POST /payments/:id/complete |
| `canViewPayrollHistory` | View transaction history | GET /history |
| `canExportPayrollPayments` | Export payment reports | GET /reports?format=csv |

**Note:** System administrators have access to all endpoints regardless of permissions.

---

## API Endpoints

### Account Management

#### GET /api/payroll/account

Get payroll account details.

**Permissions:** `canAccessPayrollAccount`

**Response:**
```json
{
  "success": true,
  "data": {
    "account": {
      "id": "uuid",
      "accountNumber": "PAY-GLOBAL-001",
      "balance": 50000.00,
      "isActive": true,
      "createdAt": "2025-01-01T00:00:00.000Z",
      "updatedAt": "2025-11-24T12:00:00.000Z"
    }
  }
}
```

#### GET /api/payroll/account/balance

Get detailed balance summary with transaction breakdown.

**Permissions:** `canViewPayrollAccountBalance`

**Response:**
```json
{
  "success": true,
  "data": {
    "accountId": "uuid",
    "accountNumber": "PAY-GLOBAL-001",
    "balance": 50000.00,
    "totalDeposits": 100000.00,
    "totalPayments": 50000.00,
    "calculatedBalance": 50000.00,
    "isBalanced": true,
    "depositCount": 10,
    "paymentCount": 25
  }
}
```

---

### Deposits

#### GET /api/payroll/account/deposits

List all deposits with pagination.

**Permissions:** `canViewPayrollHistory`

**Query Parameters:**
- `limit` (number, default: 20) - Results per page
- `offset` (number, default: 0) - Pagination offset

**Response:**
```json
{
  "success": true,
  "data": {
    "deposits": [
      {
        "id": "uuid",
        "amount": 10000.00,
        "sourceBusinessId": "business-uuid",
        "business": {
          "id": "business-uuid",
          "name": "Restaurant A",
          "type": "restaurant"
        },
        "autoGeneratedNote": "Deposit from Restaurant A payroll expense",
        "transactionType": "PAYROLL_EXPENSE",
        "depositDate": "2025-11-24T10:00:00.000Z",
        "createdBy": "user-uuid",
        "createdAt": "2025-11-24T10:00:00.000Z"
      }
    ],
    "pagination": {
      "total": 50,
      "limit": 20,
      "offset": 0,
      "hasMore": true
    }
  }
}
```

#### POST /api/payroll/account/deposits

Create a new deposit from a business account.

**Permissions:** `canMakePayrollDeposits`

**Request Body:**
```json
{
  "sourceBusinessId": "business-uuid",
  "amount": 10000.00,
  "transactionType": "MANUAL_TRANSFER" // or "PAYROLL_EXPENSE"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "deposit": { /* deposit object */ },
    "newBalance": 60000.00
  }
}
```

**Errors:**
- `400` - Invalid amount or missing business ID
- `403` - Insufficient permissions or business access denied
- `422` - Insufficient business account balance

---

### Payments

#### GET /api/payroll/account/payments

List payments with filtering and pagination.

**Permissions:** `canViewPayrollHistory`

**Query Parameters:**
- `employeeId` (string) - Filter by employee
- `status` (string) - PENDING | VOUCHER_ISSUED | SIGNED | COMPLETED
- `paymentType` (string) - REGULAR_SALARY | ADVANCE | BONUS | COMMISSION
- `startDate` (ISO date) - Filter by payment date (start)
- `endDate` (ISO date) - Filter by payment date (end)
- `isAdvance` (boolean) - Filter advance payments only
- `limit` (number, default: 20)
- `offset` (number, default: 0)

**Response:**
```json
{
  "success": true,
  "data": {
    "payments": [
      {
        "id": "uuid",
        "employeeId": "employee-uuid",
        "employee": {
          "id": "employee-uuid",
          "employeeNumber": "EMP001",
          "firstName": "John",
          "lastName": "Doe",
          "fullName": "John Doe",
          "nationalId": "123456789"
        },
        "amount": 2500.00,
        "originalAmount": 2500.00,
        "adjustmentNote": null,
        "paymentType": "REGULAR_SALARY",
        "status": "COMPLETED",
        "isAdvance": false,
        "paymentDate": "2025-11-24T00:00:00.000Z",
        "paymentSchedule": "MONTHLY",
        "isLocked": true,
        "signedBy": "user-uuid",
        "signedAt": "2025-11-24T10:00:00.000Z",
        "completedBy": "manager-uuid",
        "completedAt": "2025-11-24T11:00:00.000Z",
        "createdAt": "2025-11-24T09:00:00.000Z",
        "updatedAt": "2025-11-24T11:00:00.000Z",
        "hasVoucher": true,
        "voucherNumber": "PV-20251124-0001"
      }
    ],
    "pagination": {
      "total": 100,
      "limit": 20,
      "offset": 0,
      "hasMore": true
    }
  }
}
```

#### POST /api/payroll/account/payments

Create single payment or batch payments.

**Permissions:** `canMakePayrollPayments`

**Request Body (Single Payment):**
```json
{
  "employeeId": "employee-uuid",
  "amount": 2500.00,
  "paymentType": "REGULAR_SALARY",
  "paymentSchedule": "MONTHLY",
  "adjustmentNote": "Optional note",
  "isAdvance": false
}
```

**Request Body (Batch Payments):**
```json
{
  "payments": [
    {
      "employeeId": "employee-uuid-1",
      "amount": 2500.00,
      "paymentType": "REGULAR_SALARY",
      "paymentSchedule": "MONTHLY"
    },
    {
      "employeeId": "employee-uuid-2",
      "amount": 3000.00,
      "paymentType": "REGULAR_SALARY",
      "paymentSchedule": "MONTHLY"
    }
  ]
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "payments": [/* payment objects */],
    "newBalance": 45000.00
  }
}
```

**Errors:**
- `400` - Invalid payment data
- `403` - Insufficient permissions
- `422` - Insufficient payroll account balance

#### GET /api/payroll/account/payments/:paymentId

Get single payment details.

**Permissions:** `canViewPayrollHistory`

**Response:**
```json
{
  "success": true,
  "data": {
    "payment": { /* payment object with all details */ }
  }
}
```

#### PATCH /api/payroll/account/payments/:paymentId

Update payment (only before signing).

**Permissions:** `canAdjustPaymentAmounts`

**Request Body:**
```json
{
  "amount": 2600.00,
  "adjustmentNote": "Cost of living adjustment",
  "paymentType": "REGULAR_SALARY",
  "paymentSchedule": "MONTHLY"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "payment": { /* updated payment */ },
    "newBalance": 45100.00
  }
}
```

**Errors:**
- `403` - Payment is locked (already signed)
- `422` - Invalid update data or insufficient balance

#### DELETE /api/payroll/account/payments/:paymentId

Delete payment (only before signing).

**Permissions:** `canMakePayrollPayments`

**Response:**
```json
{
  "success": true,
  "message": "Payment deleted successfully",
  "data": {
    "newBalance": 47500.00
  }
}
```

**Errors:**
- `403` - Payment is locked (already signed)

#### POST /api/payroll/account/payments/:paymentId/sign

Sign payment (locks it from further edits).

**Permissions:** `canMakePayrollPayments`

**Response:**
```json
{
  "success": true,
  "data": {
    "payment": {
      /* payment object with isLocked: true, signedBy, signedAt */
    }
  }
}
```

#### POST /api/payroll/account/payments/:paymentId/complete

Mark payment as completed by manager.

**Permissions:** `canCompletePayments`

**Response:**
```json
{
  "success": true,
  "data": {
    "payment": {
      /* payment object with status: "COMPLETED", completedBy, completedAt */
    }
  }
}
```

---

### Vouchers

#### POST /api/payroll/account/payments/:paymentId/voucher

Generate or regenerate payment voucher.

**Permissions:** `canIssuePaymentVouchers`

**Request Body:**
```json
{
  "action": "generate", // or "regenerate"
  "format": "html" // or "pdf"
}
```

**Response:**
- For `format: "html"`: Returns HTML string
- For `format: "pdf"`: Returns PDF binary data

**Voucher Number Format:** `PV-YYYYMMDD-NNNN` (e.g., PV-20251124-0001)

**Errors:**
- `404` - Payment not found
- `422` - Voucher already exists (use "regenerate" action)

---

### History & Reports

#### GET /api/payroll/account/history

Get combined transaction history (deposits + payments).

**Permissions:** `canViewPayrollHistory`

**Query Parameters:**
- `startDate` (ISO date)
- `endDate` (ISO date)
- `limit` (number, default: 50)
- `offset` (number, default: 0)

**Response:**
```json
{
  "success": true,
  "data": {
    "transactions": [
      {
        "id": "uuid",
        "type": "DEPOSIT", // or "PAYMENT"
        "amount": 10000.00,
        "date": "2025-11-24T10:00:00.000Z",
        "description": "Deposit from Restaurant A",
        "balanceAfter": 60000.00
      }
    ],
    "pagination": { /* ... */ }
  }
}
```

#### GET /api/payroll/account/reports

Generate payment reports with export options.

**Permissions:** `canExportPayrollPayments`

**Query Parameters:**
- Same filters as GET /payments
- `format` (string) - "json" | "csv"
- `groupBy` (string) - "employee" | "paymentType" | "date"

**Response (JSON):**
```json
{
  "success": true,
  "data": {
    "report": [
      {
        "employeeId": "uuid",
        "employeeName": "John Doe",
        "employeeNumber": "EMP001",
        "totalPayments": 25000.00,
        "paymentCount": 10,
        "averagePayment": 2500.00
      }
    ],
    "summary": {
      "totalAmount": 250000.00,
      "totalPayments": 100,
      "dateRange": {
        "start": "2025-01-01",
        "end": "2025-11-24"
      }
    }
  }
}
```

**Response (CSV):**
Returns CSV file with headers and payment data.

---

## Data Models

### PayrollAccount

```typescript
{
  id: string // UUID
  businessId: string | null // null for global account
  accountNumber: string // e.g., "PAY-GLOBAL-001"
  balance: number // Decimal(12,2)
  isActive: boolean
  createdAt: Date
  updatedAt: Date
  createdBy: string // User ID
}
```

### PayrollPayment

```typescript
{
  id: string
  payrollAccountId: string
  employeeId: string
  payrollEntryId: string | null
  amount: number
  originalAmount: number | null
  adjustmentNote: string | null
  paymentType: "REGULAR_SALARY" | "ADVANCE" | "BONUS" | "COMMISSION"
  paymentDate: Date
  paymentSchedule: "WEEKLY" | "BIWEEKLY" | "MONTHLY" | null
  status: "PENDING" | "VOUCHER_ISSUED" | "SIGNED" | "COMPLETED"
  isAdvance: boolean
  deductions: JSON | null
  commissionAmount: number | null
  isLocked: boolean // true after signing
  signedBy: string | null
  signedAt: Date | null
  completedBy: string | null
  completedAt: Date | null
  createdBy: string
  createdAt: Date
  updatedAt: Date
}
```

### PayrollPaymentVoucher

```typescript
{
  id: string
  paymentId: string
  voucherNumber: string // PV-YYYYMMDD-NNNN
  employeeNumber: string
  employeeName: string
  employeeNationalId: string
  amount: number
  paymentDate: Date
  issuedAt: Date
  signedAt: Date | null
  signatureData: string | null
  regenerationCount: number
  lastRegeneratedAt: Date | null
  notes: string | null
}
```

---

## Error Handling

### Error Response Format

```json
{
  "error": "Error message",
  "details": "Additional error details",
  "code": "ERROR_CODE"
}
```

### Common Error Codes

| Code | HTTP Status | Description |
|------|-------------|-------------|
| `UNAUTHORIZED` | 401 | Not authenticated |
| `FORBIDDEN` | 403 | Insufficient permissions |
| `NOT_FOUND` | 404 | Resource not found |
| `VALIDATION_ERROR` | 400 | Invalid request data |
| `INSUFFICIENT_BALANCE` | 422 | Not enough funds |
| `PAYMENT_LOCKED` | 403 | Cannot modify signed payment |
| `DUPLICATE_VOUCHER` | 422 | Voucher already exists |
| `SERVER_ERROR` | 500 | Internal server error |

---

## Usage Examples

### Example 1: Create Deposit

```javascript
const response = await fetch('/api/payroll/account/deposits', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  credentials: 'include',
  body: JSON.stringify({
    sourceBusinessId: 'business-uuid',
    amount: 10000.00,
    transactionType: 'MANUAL_TRANSFER',
  }),
})

const data = await response.json()
console.log('New balance:', data.data.newBalance)
```

### Example 2: Create Batch Payments

```javascript
const payments = employees.map(emp => ({
  employeeId: emp.id,
  amount: emp.salary,
  paymentType: 'REGULAR_SALARY',
  paymentSchedule: 'MONTHLY',
}))

const response = await fetch('/api/payroll/account/payments', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  credentials: 'include',
  body: JSON.stringify({ payments }),
})

const data = await response.json()
console.log(`Created ${data.data.payments.length} payments`)
```

### Example 3: Generate Voucher

```javascript
const response = await fetch(`/api/payroll/account/payments/${paymentId}/voucher`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  credentials: 'include',
  body: JSON.stringify({
    action: 'generate',
    format: 'html',
  }),
})

const html = await response.text()
const newWindow = window.open('', '_blank')
newWindow.document.write(html)
newWindow.document.close()
```

### Example 4: Export to CSV

```javascript
const params = new URLSearchParams({
  format: 'csv',
  startDate: '2025-01-01',
  endDate: '2025-12-31',
})

const response = await fetch(`/api/payroll/account/reports?${params}`, {
  credentials: 'include',
})

const blob = await response.blob()
const url = window.URL.createObjectURL(blob)
const a = document.createElement('a')
a.href = url
a.download = 'payroll-report.csv'
a.click()
```

---

## Security Considerations

### 1. Payment Immutability

Once a payment is signed (`isLocked: true`), it cannot be edited or deleted. This ensures audit trail integrity and prevents tampering with payment records.

### 2. Permission Checks

All endpoints validate user permissions before processing requests. System administrators bypass these checks.

### 3. Balance Validation

- Deposits check source business account balance
- Payments check payroll account balance
- All transactions are atomic (rollback on failure)

### 4. Voucher Security

- Voucher numbers are sequential and date-based
- Regeneration is tracked with timestamps and counts
- Vouchers include employee identification details

### 5. Data Isolation

- Business account access is verified for deposits
- Employee payment history is permission-protected
- Reports respect user access levels

### 6. Audit Trail

Every transaction records:
- Creator user ID
- Creation timestamp
- Update timestamp
- Signer user ID (for payments)
- Completer user ID (for payments)

---

## Support & Maintenance

For issues or questions:
- GitHub: [multi-business-multi-apps/issues](https://github.com/yourusername/multi-business-multi-apps/issues)
- Documentation: See project README
- API Updates: Check commit history for changes

---

**Last Updated:** 2025-11-24
**API Version:** 1.0.0
