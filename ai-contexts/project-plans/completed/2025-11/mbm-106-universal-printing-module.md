# Feature Development Session Template

> **Template Type:** Feature Development
> **Version:** 1.0
> **Last Updated:** October 17, 2025

---

## ğŸ¯ Purpose

For creating new features, screens, or endpoints with structured planning.

---

## ğŸ“‹ Required Context Documents

**IMPORTANT:** Before starting this session, load the following context documents **IN THE EXACT ORDER LISTED BELOW**.

### Core Contexts (Load in this EXACT order - ONE AT A TIME)

**CRITICAL:** Read these files sequentially. Do not proceed to the next document until you have fully read and understood the previous one.

1. **FIRST:** `ai-contexts/master-context.md` - General principles and conventions
   - âš ï¸ Contains critical instruction to read code-workflow.md
   - âš ï¸ Defines operating principles
   - âš ï¸ Contains mandatory workflow enforcement
   - âš ï¸ Defines example adherence requirements

2. **SECOND:** `ai-contexts/code-workflow.md` - Standard workflow and task tracking
   - Contains MANDATORY workflow requirements
   - Requires creating project plan BEFORE any code changes
   - Defines approval checkpoint process

### Feature-Specific Contexts (Load as needed after core contexts)

- `ai-contexts/frontend/component-context.md` - For UI component development
- `ai-contexts/frontend/ui-context.md` - For UI consistency and styling
- `ai-contexts/backend/backend-api-context.md` - For API endpoint development
- `ai-contexts/backend/database-context.md` - For database schema changes
- `ai-contexts/testing/unit-testing-context.md` - For test coverage

### Optional Contexts

- Domain-specific contexts based on the module being developed

**How to load:** Use the Read tool to load each relevant context document before beginning work.

---

## ğŸš€ Session Objective

<!-- Fill in your specific feature requirements before starting -->

**Ticket:** mbm-106

**Feature Name:** Universal Printing Module

**Feature Description:**
We want to introduce a universal printing module that that can be used for printing receipts and labels.

Each business may have further refinements for example a restaurant business can print two receipts for each sale one for the kitchen that may have additional instructions for the shef  based on the order and the other for the customer. Recceipts will have a receipt number generated by the system. In addition on each day the receipts will also have another number signifying how may receipts printed that day for the business starting from say 001 and it resets every day.

clothing or grocery busness will have different receipt formarts depending on need.

Each receipt will have business information and who the sales person was who printed the receipt, this would be the logged in person.

We also want a feature similar to the existing sync service for replication data across machines, we want to extend the same functionality to share receipt printers. So for every configured receipt printer admin can designate that printer as sharable from from any system. In other words computers will broad cast available printers to all other systems connected, however the system admin will beed to confugure through the universal printer management UI which printers are sharable.

Users will need permissions that allow them to print on other systems's printers

Ability to print labels for the purposes of attaching SKUs to items. So as part of stocking or editting an inventory item the user can print SKU labels.

The universal printing management UI should have similiar capabilities like the universal categery management and seemlessly integrate with it to be able to print inventory labels as needed.

**Target Module/Component:**
- Universal Printing Module (new module)
- Integration with existing sync service
- Integration with universal inventory management
- Admin printer management UI
- User printer selection UI

**API Endpoints (if applicable):**
- `POST/GET /api/printers` - Register and list printers
- `PUT/DELETE /api/printers/[id]` - Update/delete printer
- `GET /api/printers/discover` - Discover network printers via mDNS
- `POST /api/print/receipt` - Generate and queue receipt print job
- `POST /api/print/label` - Generate and queue label print job
- `GET /api/print/jobs` - List print jobs with filtering
- `POST /api/print/jobs/[id]/retry` - Retry failed print job
- `GET/POST /api/sync/printers` - Sync printer availability across nodes

**UI/UX Requirements:**
- **Admin Printer Management UI**: Similar to universal category management
  - List all registered printers (local + network)
  - Add/edit/delete printers
  - Configure printer as sharable across network
  - Test print functionality
  - View print job queue and history
  - Printer status indicators (online/offline)
- **User Printer Selection Modal**:
  - Show available printers (local + shared network printers based on permissions)
  - Preview receipt/label before printing
  - Select number of copies
  - Print job status notifications (toast)
- **Inventory Integration**:
  - Print label button on inventory grid rows
  - Print on save checkbox in inventory form
  - Bulk label printing (select multiple items)
- **Sales/Checkout Integration**:
  - Print receipt button on order completion
  - Auto-print option on checkout
- Use useAlert() and useConfirm() hooks (per custom UI standards)

**Acceptance Criteria:**

**Core Printing:**
- âœ… Admin can register thermal receipt printers and label printers
- âœ… Admin can configure printers as sharable across network
- âœ… Users can print receipts with correct business-specific format for ALL 10 business types
- âœ… Receipts have dual numbering (global UUID + daily sequence 001, 002, etc.)
- âœ… Daily sequence resets at midnight (timezone-aware)
- âœ… Users can print SKU labels from inventory screens
- âœ… Labels include barcode generation (Code128 format)

**Network Printer Sharing:**
- âœ… Printers are broadcasted via mDNS (extending existing sync service)
- âœ… Printers appear on all connected sync nodes if marked as sharable
- âœ… Users can print to remote printers (with proper permissions)
- âœ… Print jobs are routed correctly across network nodes
- âœ… Registration key validates cross-node printer access

**Business-Specific Templates (ALL 10):**
- âœ… **Restaurant**: Dual receipts (kitchen + customer), allergens, dietary info, spice level, prep time
- âœ… **Clothing**: Size/color variants, return policy, seasonal info
- âœ… **Grocery**: Expiration dates, weight/unit pricing, perishable indicators
- âœ… **Hardware**: Cut-to-size dimensions, bulk pricing, special orders
- âœ… **Construction**: Project code, contractor info, budget tracking
- âœ… **Vehicles**: Service records, mileage, maintenance details
- âœ… **Consulting**: Service hours, hourly rates, client info
- âœ… **Retail**: Loyalty points, promotions, standard format
- âœ… **Services**: Labor hours, parts, warranty info
- âœ… **Other**: Generic fallback template

**Permissions & Security:**
- âœ… `canManageNetworkPrinters` permission (admin only)
- âœ… `canUseLabelPrinters` permission (users)
- âœ… `canPrintReceipts` permission (users)
- âœ… `canPrintInventoryLabels` permission (users)
- âœ… `canViewPrintQueue` permission (admin)
- âœ… Permission checks enforce who can print to network printers
- âœ… Audit logging for printer operations

**Reliability:**
- âœ… Print jobs queued (FIFO processing)
- âœ… Failed jobs automatically retry with exponential backoff
- âœ… Offline printers queue jobs for later processing
- âœ… Print job history retained for 30 days
- âœ… Admin can manually retry failed jobs from queue dashboard

**UX:**
- âœ… Print preview before confirming
- âœ… Toast notifications for print success/failure
- âœ… Printer status indicators (online/offline/busy)
- âœ… Helpful error messages for permission issues or printer offline

---

## ğŸ“ Technical Specifications

### Architecture
- **Queue-Based Print Job System**: All print requests go through job queue for reliability
- **mDNS Printer Discovery**: Extends existing sync service mDNS for printer broadcasting
- **Template Engine**: Business-specific receipt templates with fallback to generic
- **Dual Numbering System**: UUID for database + daily sequence counter with midnight reset

### Technologies
- **Node.js/Next.js**: Backend API and frontend
- **Prisma ORM**: Database schema and migrations
- **Existing Sync Service**: Extends peer discovery for printer sharing
- **ESC/POS**: Thermal receipt printer command language
- **ZPL**: Zebra label printer format (optional, Phase 2)
- **React**: Frontend components
- **TypeScript**: Type safety for printer, job, receipt, label types

### Dependencies

**External Libraries:**
- `node-thermal-printer` - ESC/POS printer support for receipts
- `bwip-js` - Barcode generation for labels (Code128, UPC)
- `qrcode` (optional) - QR code generation for receipts

**Internal Dependencies:**
- Existing sync service (critical - extends mDNS, peer discovery, registration key auth)
- Permission system (extends with printer permissions)
- Universal category management (pattern to follow for UI)
- Inventory management (integration for label printing)
- Sales/Order system (integration for receipt printing)

### Data Models

**NetworkPrinters** (synced across nodes):
```typescript
{
  id: string (UUID)
  printerId: string (unique identifier)
  printerName: string
  printerType: 'label' | 'receipt' | 'document'
  nodeId: string (which sync node owns this printer)
  ipAddress: string
  port: number
  capabilities: Json (e.g., ['esc-pos', 'zebra-zpl'])
  isShareable: boolean (admin configured)
  isOnline: boolean
  lastSeen: DateTime
  createdAt: DateTime
  updatedAt: DateTime
}
```

**PrintJobs** (NOT synced - local to node):
```typescript
{
  id: string (UUID)
  printerId: string (FK to NetworkPrinters)
  businessId: string
  businessType: string (restaurant, clothing, etc.)
  userId: string (who initiated print)
  jobType: 'receipt' | 'label'
  jobData: Json (receipt/label content)
  status: 'PENDING' | 'PROCESSING' | 'COMPLETED' | 'FAILED'
  retryCount: number
  errorMessage: string?
  createdAt: DateTime
  processedAt: DateTime?
}
```

**ReceiptSequences** (per business, daily reset):
```typescript
{
  id: string (UUID)
  businessId: string
  date: Date (YYYY-MM-DD)
  lastSequence: number (resets daily, 001, 002, 003...)
  createdAt: DateTime
  updatedAt: DateTime

  @@unique([businessId, date])
}
```

### Integration Points

**1. Sync Service Integration:**
- Extend `peer-discovery.ts` to broadcast printer info in mDNS packets
- Add printer capabilities to node presence messages
- Sync NetworkPrinters table across nodes (excluded: PrintJobs)
- Validate registration key for cross-node printer access

**2. Inventory Integration:**
- Add "Print Label" button to `universal-inventory-grid.tsx` row actions
- Add "Print on Save" checkbox to `universal-inventory-form.tsx`
- Bulk print: select multiple items â†’ batch label generation

**3. Sales/Order Integration:**
- Add "Print Receipt" button to order completion screens
- Auto-print option on checkout (configurable per business)
- Restaurant: trigger dual print (kitchen + customer)

**4. Permission Integration:**
- Extend `permission-utils.ts` with printer permission checks
- Add printer permissions to user/business permission types
- UI: hide print buttons if user lacks permission

**5. Admin UI Integration:**
- Add "Printer Management" to admin sidebar navigation
- Follow universal category management patterns (similar UI/UX)

---

## ğŸ§ª Testing Requirements

### Unit Tests

**Printer Service (`printer-service.ts`):**
- âœ… Register new printer (local and network)
- âœ… Update printer configuration
- âœ… Delete printer
- âœ… List printers with filtering (by type, node, status)
- âœ… Mark printer online/offline

**Receipt Numbering (`receipt-numbering.ts`):**
- âœ… Generate global receipt ID (UUID)
- âœ… Generate daily sequence number (001, 002, 003...)
- âœ… Daily sequence reset at midnight (test timezone handling)
- âœ… Concurrent sequence generation (no duplicates)

**Print Job Queue (`print-job-queue.ts`):**
- âœ… Queue print job
- âœ… Process job (FIFO order)
- âœ… Retry failed job with exponential backoff
- âœ… Max retry count reached â†’ mark as FAILED
- âœ… Job status transitions (PENDING â†’ PROCESSING â†’ COMPLETED/FAILED)

**Receipt Templates (`receipt-templates.ts`):**
- âœ… Generate restaurant receipt (kitchen and customer)
- âœ… Generate clothing receipt (with variants)
- âœ… Generate grocery receipt (with expiration)
- âœ… Generate hardware receipt (with dimensions)
- âœ… Generate construction invoice
- âœ… Generate vehicles service receipt
- âœ… Generate consulting invoice
- âœ… Generate retail receipt (with loyalty points)
- âœ… Generate services receipt (with warranty)
- âœ… Generate generic fallback receipt
- âœ… Include business info and salesperson on all receipts

**Label Generator (`label-generator.ts`):**
- âœ… Generate SKU label with barcode (Code128)
- âœ… Business-specific label formats (grocery with expiration, clothing with size/color)
- âœ… Barcode validation

**Printer Discovery (`printer-discovery.ts`):**
- âœ… Broadcast printer info via mDNS
- âœ… Receive printer broadcast from peer nodes
- âœ… Register discovered printer in database
- âœ… Update printer last seen timestamp

### Integration Tests

**API Endpoints:**
- âœ… POST /api/printers - register printer with validation
- âœ… GET /api/printers - list printers with permissions
- âœ… PUT /api/printers/[id] - update printer (admin only)
- âœ… DELETE /api/printers/[id] - delete printer (admin only)
- âœ… GET /api/printers/discover - trigger mDNS discovery
- âœ… POST /api/print/receipt - queue receipt print job
- âœ… POST /api/print/label - queue label print job
- âœ… GET /api/print/jobs - list jobs with filtering
- âœ… POST /api/print/jobs/[id]/retry - retry failed job (admin only)

**Sync Service Integration:**
- âœ… Node A broadcasts printer â†’ Node B receives and registers it
- âœ… Printer marked sharable â†’ appears on all nodes
- âœ… Printer marked non-sharable â†’ only visible on owning node
- âœ… Node goes offline â†’ printer marked offline on peers
- âœ… Registration key mismatch â†’ printer access denied

**Database:**
- âœ… Concurrent receipt sequence generation (no duplicates under load)
- âœ… Daily sequence unique constraint enforced
- âœ… Print job foreign key to printer
- âœ… Cascading delete (delete printer â†’ update jobs to failed)

**Permissions:**
- âœ… User without `canManageNetworkPrinters` â†’ 403 on admin endpoints
- âœ… User without `canPrintReceipts` â†’ 403 on receipt printing
- âœ… User without `canUseLabelPrinters` â†’ 403 on label printing
- âœ… Admin can view all print jobs, users only see their own

### E2E Tests

**1. Happy Path - Label Printing:**
- âœ… Admin registers label printer
- âœ… User opens inventory, clicks "Print Label" on item
- âœ… Printer selection modal appears with available printers
- âœ… User previews label (SKU, barcode, price)
- âœ… User confirms print â†’ job queued â†’ success toast
- âœ… Label prints successfully on thermal printer

**2. Happy Path - Receipt Printing (Restaurant):**
- âœ… Admin registers receipt printer as sharable
- âœ… Restaurant user completes order with allergens and spice level
- âœ… User clicks "Print Receipt"
- âœ… System generates two receipts: kitchen (with cooking instructions) + customer (with payment)
- âœ… Both receipts have correct dual numbering (global + daily sequence)
- âœ… Kitchen receipt shows allergens âš ï¸, spice level ğŸŒ¶ï¸, prep time
- âœ… Customer receipt shows prices, total, server name

**3. Cross-Node Printing:**
- âœ… Node A has thermal printer configured as sharable
- âœ… Node B user sees Node A's printer in selection modal
- âœ… Node B user prints label to Node A's printer
- âœ… Print job routed via sync service to Node A
- âœ… Node A processes job and prints
- âœ… Node B user receives success notification

**4. Error Handling - Printer Offline:**
- âœ… User prints to printer that's offline
- âœ… Job queued with status PENDING
- âœ… Auto-retry every 30s with exponential backoff
- âœ… When printer comes online â†’ job processes successfully
- âœ… User sees toast: "Print queued, printer offline. Will retry automatically."

**5. Error Handling - No Permission:**
- âœ… User without printer permission opens inventory
- âœ… Print label button is hidden
- âœ… User tries API call directly â†’ 403 Forbidden
- âœ… Error message: "You don't have permission to print labels. Contact admin."

**6. Daily Sequence Reset:**
- âœ… Business prints receipts throughout the day (001, 002, 003... 050)
- âœ… System clock reaches midnight
- âœ… Next receipt printed has sequence 001 (reset)
- âœ… Previous day's receipts retain their old sequence numbers
- âœ… Works correctly across timezones

**7. Bulk Label Printing:**
- âœ… User selects 20 inventory items in grid
- âœ… Clicks "Print Labels" bulk action
- âœ… Printer selection modal appears
- âœ… User selects printer and number of copies (1 per item)
- âœ… 20 print jobs queued
- âœ… Jobs processed in order (FIFO)
- âœ… All 20 labels print successfully

**8. Business-Specific Templates:**
- âœ… Clothing business prints receipt â†’ shows size/color variants, return policy
- âœ… Grocery business prints receipt â†’ shows expiration dates, weight pricing
- âœ… Hardware business prints receipt â†’ shows cut-to-size dimensions
- âœ… Construction business prints invoice â†’ shows project code, budget
- âœ… All receipts include business name, salesperson, transaction ID

---

## ğŸ“ Session Notes

### ğŸ”„ Requirements-Plan Synchronization

**Last Synced:** 2025-11-13
**Synced With:** `projectplan-mbm-106-universal-printing-module-2025-11-13.md`

**What Was Synced:**
- âœ… Complete API endpoint specifications (8 endpoints)
- âœ… Detailed UI/UX requirements (admin + user interfaces)
- âœ… Comprehensive acceptance criteria (core, network, business-specific, permissions, reliability, UX)
- âœ… All 10 business type template requirements (restaurant, clothing, grocery, hardware, construction, vehicles, consulting, retail, services, other)
- âœ… Technical architecture decisions (queue-based, mDNS discovery, dual numbering)
- âœ… External dependencies (node-thermal-printer, bwip-js, qrcode)
- âœ… Database models (NetworkPrinters, PrintJobs, ReceiptSequences with Prisma schema details)
- âœ… Integration points (sync service, inventory, sales, permissions, admin UI)
- âœ… Complete testing requirements (unit, integration, E2E with 8 test scenarios)

**Status:** âœ… Requirements and plan are IN SYNC

---

## âœ… Start Session

Ready to begin feature development. Please:

1. Review the feature requirements âœ… COMPLETE
2. Propose an implementation plan âœ… COMPLETE (see project plan)
3. Identify technical challenges or considerations âœ… COMPLETE (see risk assessment in plan)
4. Suggest a testing strategy âœ… COMPLETE (see testing requirements above)

**Next Step:** Type `PHASE 1` to begin Phase 1 implementation (Database Schema & Types)

---
